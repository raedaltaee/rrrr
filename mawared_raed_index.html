<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฅุฏุงุฑุฉ ููุชุงุจุนุฉ ุงูุจุฑูุฏ ุงูุญูููู - ุฏููุงู ุงูููู ุงูุดูุนู</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        .sidebar-icon {
            font-size: 1.5rem;
            line-height: 1;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white text-gray-800 p-4 shadow-lg flex-shrink-0">
            <div class="text-center py-4 border-b">
                <h1 class="text-xl font-bold text-slate-800">ุฏููุงู ุงูููู ุงูุดูุนู</h1>
                <p class="text-sm text-slate-500">ูุธุงู ุงูุจุฑูุฏ ุงูุญูููู</p>
            </div>
            <nav class="mt-8">
                <ul>
                    <li><a href="#dashboard" class="nav-link flex items-center p-3 my-1 bg-sky-100 text-sky-700 rounded-lg font-bold"><span class="sidebar-icon me-3">๐</span> ููุญุฉ ุงูุชุญูู</a></li>
                    <li><a href="#mail" class="nav-link flex items-center p-3 my-1 hover:bg-sky-100 hover:text-sky-700 rounded-lg font-semibold"><span class="sidebar-icon me-3">โ๏ธ</span> ุฅุฏุงุฑุฉ ุงูุจุฑูุฏ</a></li>
                    <li><a href="#hr" class="nav-link flex items-center p-3 my-1 hover:bg-sky-100 hover:text-sky-700 rounded-lg font-semibold"><span class="sidebar-icon me-3">๐ฅ</span> ุงูููุธููู</a></li>
                    <li><a href="#reports" class="nav-link flex items-center p-3 my-1 hover:bg-sky-100 hover:text-sky-700 rounded-lg font-semibold"><span class="sidebar-icon me-3">๐</span> ุงูุชูุงุฑูุฑ</a></li>
                </ul>
            </nav>
            <div class="mt-auto text-center pt-8">
                 <p class="text-xs text-gray-500">ุชุตููู ูุชุทููุฑ: ุฑ. ูููุฏุณูู</p>
                 <p class="text-sm font-semibold text-gray-700">ุฑุงุฆุฏ ุฅุจุฑุงููู ุฎููู</p>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <div id="header-title" class="text-xl font-bold text-slate-700">ููุญุฉ ุงูุชุญูู</div>
                <div class="flex items-center">
                    <span class="text-sm font-semibold">ูุฑุญุจุงู, ูุฏูุฑ ุงููุธุงู</span>
                    <button class="bg-red-500 text-white px-4 py-2 rounded-lg ms-4 hover:bg-red-600 transition-colors">ุฎุฑูุฌ</button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 p-6 overflow-y-auto">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-5 rounded-xl shadow text-center">
                            <h3 class="text-gray-500 font-semibold">ุฅุฌูุงูู ุงููุนุงููุงุช</h3>
                            <p id="total-mail-kpi" class="text-4xl font-bold text-sky-600 mt-2">0</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow text-center">
                            <h3 class="text-gray-500 font-semibold">ูุนุงููุงุช ุฌุฏูุฏุฉ</h3>
                            <p id="new-mail-kpi" class="text-4xl font-bold text-amber-500 mt-2">0</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow text-center">
                            <h3 class="text-gray-500 font-semibold">ููุฏ ุงูุฅุฌุฑุงุก</h3>
                            <p id="progress-mail-kpi" class="text-4xl font-bold text-indigo-500 mt-2">0</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow text-center">
                            <h3 class="text-gray-500 font-semibold">ูุนุงููุงุช ููุฌุฒุฉ</h3>
                            <p id="completed-mail-kpi" class="text-4xl font-bold text-green-500 mt-2">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow lg:col-span-3">
                            <h3 class="font-bold text-lg mb-4">ุญุฌู ุงูุจุฑูุฏ ุงูุดูุฑู (ุขุฎุฑ 6 ุฃุดูุฑ)</h3>
                            <div class="chart-container" style="height: 250px;"><canvas id="mailVolumeChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow lg:col-span-2">
                            <h3 class="font-bold text-lg mb-4">ุญุงูุฉ ุงูุจุฑูุฏ</h3>
                            <div class="chart-container" style="height: 250px;"><canvas id="mailStatusChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Mail View -->
                <div id="mail-view" class="view hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <h2 class="text-xl font-bold text-slate-700">ุณุฌู ุงูุจุฑูุฏ ุงูุญูููู</h2>
                            <div class="flex items-center gap-2">
                                <input type="text" id="mailSearch" placeholder="ุงุจุญุซ ูู ุงูููุถูุน ุฃู ุงูุฌูุฉ..." class="border p-2 rounded-lg w-64">
                                <button id="add-mail-btn" class="bg-sky-600 text-white px-5 py-2 rounded-lg hover:bg-sky-700 font-bold">ุฅุถุงูุฉ ุจุฑูุฏ ุฌุฏูุฏ</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="border-b-2">
                                    <tr>
                                        <th class="p-3">ุฑูู ุงููุชุงุจ</th>
                                        <th class="p-3">ุงูุชุงุฑูุฎ</th>
                                        <th class="p-3">ุงูููุน</th>
                                        <th class="p-3">ุงูุฌูุฉ</th>
                                        <th class="p-3">ุงูููุถูุน</th>
                                        <th class="p-3">ุงูุญุงูุฉ</th>
                                        <th class="p-3">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="mailTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Mail Details View -->
                <div id="mail-details-view" class="view hidden">
                    <button class="back-to-mail mb-4 bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">&rarr; ุงูุนูุฏุฉ ุฅูู ุณุฌู ุงูุจุฑูุฏ</button>
                    <div class="bg-white p-8 rounded-xl shadow-md" id="mail-details-content">
                    </div>
                </div>
                
                <!-- HR View -->
                <div id="hr-view" class="view hidden">
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-slate-700">ูุงุฆูุฉ ุงูููุธููู</h2>
                            <button id="add-employee-btn" class="bg-sky-600 text-white px-5 py-2 rounded-lg hover:bg-sky-700 font-bold">ุฅุถุงูุฉ ููุธู</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="border-b-2">
                                    <tr>
                                        <th class="p-3">ุงูุงุณู</th>
                                        <th class="p-3">ุงูููุตุจ</th>
                                        <th class="p-3">ุงููุณู</th>
                                        <th class="p-3">ุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports View -->
                <div id="reports-view" class="view hidden">
                    <h2 class="text-2xl font-bold text-slate-700 mb-2">ุงูุชูุงุฑูุฑ ูุงูุชุญูููุงุช</h2>
                    <p class="text-gray-600 mb-6">ูุธุฑุฉ ุดุงููุฉ ุนูู ุฃุฏุงุก ูููุงุกุฉ ูุธุงู ุงูุจุฑูุฏ.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-5 rounded-xl shadow text-center">
                             <h3 class="text-gray-500 font-semibold">ูุชูุณุท ููุช ุงูุฅูุฌุงุฒ</h3>
                             <p class="text-4xl font-bold text-cyan-600 mt-2">3.2 <span class="text-xl">ุฃูุงู</span></p>
                        </div>
                         <div class="bg-white p-5 rounded-xl shadow">
                             <h3 class="text-gray-500 font-semibold text-center">ุชูุฒูุน ุงูุจุฑูุฏ ุญุณุจ ุงูุฃููููุฉ</h3>
                             <div class="chart-container" style="height: 120px"><canvas id="priority-report-chart"></canvas></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow">
                            <h3 class="text-gray-500 font-semibold text-center">ุชูุฒูุน ุงูุจุฑูุฏ ุญุณุจ ุงูููุน</h3>
                            <div class="chart-container" style="height: 120px"><canvas id="type-report-chart"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-bold text-lg mb-4">ุชุญููู ุฃุฏุงุก ุงูููุธููู (ุนุฏุฏ ุงููุนุงููุงุช)</h3>
                        <div class="chart-container" style="height: 350px;"><canvas id="employee-performance-chart"></canvas></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Mail Modal -->
    <div id="mail-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="mail-modal-title" class="text-2xl font-bold mb-6">ุฅุถุงูุฉ ุจุฑูุฏ ุฌุฏูุฏ</h2>
            <form id="mail-form">
                <input type="hidden" id="mail-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="mail-type" class="block font-semibold mb-1">ููุน ุงูุจุฑูุฏ</label>
                        <select id="mail-type" class="w-full border p-2 rounded-lg" required>
                            <option value="incoming">ูุงุฑุฏ</option>
                            <option value="outgoing">ุตุงุฏุฑ</option>
                        </select>
                    </div>
                    <div>
                        <label for="mail-number" class="block font-semibold mb-1">ุฑูู ุงููุชุงุจ</label>
                        <input type="text" id="mail-number" class="w-full border p-2 rounded-lg" required>
                    </div>
                    <div>
                        <label for="mail-date" class="block font-semibold mb-1">ุชุงุฑูุฎ ุงููุชุงุจ</label>
                        <input type="date" id="mail-date" class="w-full border p-2 rounded-lg" required>
                    </div>
                    <div>
                        <label for="mail-entity" class="block font-semibold mb-1">ุงูุฌูุฉ (ุงููุงุฑุฏ ูููุง / ุงูุตุงุฏุฑ ุฅูููุง)</label>
                        <input type="text" id="mail-entity" class="w-full border p-2 rounded-lg" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="mail-subject" class="block font-semibold mb-1">ุงูููุถูุน</label>
                        <textarea id="mail-subject" rows="3" class="w-full border p-2 rounded-lg" required></textarea>
                    </div>
                    <div>
                        <label for="mail-priority" class="block font-semibold mb-1">ุงูุฃููููุฉ</label>
                        <select id="mail-priority" class="w-full border p-2 rounded-lg">
                            <option value="normal">ุนุงุฏู</option>
                            <option value="urgent">ุนุงุฌู</option>
                        </select>
                    </div>
                     <div>
                        <label for="mail-assignee" class="block font-semibold mb-1">ุงูููุธู ุงููุณุคูู</label>
                        <select id="mail-assignee" class="w-full border p-2 rounded-lg">
                        </select>
                    </div>
                     <div class="md:col-span-2">
                        <label for="mail-notes" class="block font-semibold mb-1">ููุงุญุธุงุช</label>
                        <textarea id="mail-notes" rows="2" class="w-full border p-2 rounded-lg"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" class="modal-cancel-btn bg-gray-300 px-6 py-2 rounded-lg hover:bg-gray-400">ุฅูุบุงุก</button>
                    <button type="submit" class="bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700 font-bold">ุญูุธ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employee-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="employee-modal-title" class="text-2xl font-bold mb-6">ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</h2>
            <form id="employee-form">
                <input type="hidden" id="employee-id">
                <div class="space-y-4">
                    <div>
                        <label for="employee-name" class="block font-semibold mb-1">ุงุณู ุงูููุธู</label>
                        <input type="text" id="employee-name" class="w-full border p-2 rounded-lg" required>
                    </div>
                    <div>
                        <label for="employee-title" class="block font-semibold mb-1">ุงูููุตุจ</label>
                        <input type="text" id="employee-title" class="w-full border p-2 rounded-lg" required>
                    </div>
                    <div>
                        <label for="employee-department" class="block font-semibold mb-1">ุงููุณู</label>
                        <input type="text" id="employee-department" class="w-full border p-2 rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" class="modal-cancel-btn bg-gray-300 px-6 py-2 rounded-lg hover:bg-gray-400">ุฅูุบุงุก</button>
                    <button type="submit" class="bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700 font-bold">ุญูุธ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content text-center max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">ุชุฃููุฏ ุงูุญุฐู</h2>
            <p id="confirm-modal-body" class="mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุนูุตุฑุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 px-6 py-2 rounded-lg hover:bg-gray-400">ุฅูุบุงุก</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 font-bold">ุญุฐู</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- MOCK DATA ---
    let employeeData = [
        { id: 1, name: 'ุนูู ุญุณู', title: 'ูููุฏุณ ูุฏูู', department: 'ุงูููุฏุณุฉ'},
        { id: 2, name: 'ูุงุทูุฉ ูุญูุฏ', title: 'ูุญุงุณุจ', department: 'ุงููุงููุฉ'},
        { id: 3, name: 'ุฃุญูุฏ ูุงุณูู', title: 'ุจุงุญุซ ุดุฑุนู', department: 'ุงูุดุคูู ุงูุดุฑุนูุฉ'},
        { id: 4, name: 'ุฒููุจ ูุฑูู', title: 'ูุณุคูู ุฅุฏุงุฑู', department: 'ุงูุฅุฏุงุฑุฉ'}
    ];
    let mailData = [
        { id: 1, type: 'incoming', number: '120/ุฃ', date: '2025-06-10', entity: 'ูุญุงูุธุฉ ุจุบุฏุงุฏ', subject: 'ุจุฎุตูุต ุชุฎุตูุต ูุทุนุฉ ุฃุฑุถ ููููู', status: 'completed', priority: 'urgent', assigneeId: 3, notes: 'ุชู ุงูุฑุฏ ุจุชุงุฑูุฎ 2025-06-15', history: [{action: 'ุชู ุงูุฅูุดุงุก', by: 'ูุฏูุฑ ุงููุธุงู', date: '2025-06-10'}, {action: 'ุชู ุงูุฅูุฌุงุฒ ูุงูุฑุฏ', by: 'ุฃุญูุฏ ูุงุณูู', date: '2025-06-15'}] },
        { id: 2, type: 'outgoing', number: '345/ุจ', date: '2025-06-12', entity: 'ูุฒุงุฑุฉ ุงููุงููุฉ', subject: 'ุทูุจ ุจูุงู ูุงูู ููุฑุจุน ุงูุซุงูู', status: 'in-progress', priority: 'normal', assigneeId: 2, notes: 'ููุฏ ุงููุฑุงุฌุนุฉ ูู ุงููุณู ุงููุงูู', history: [{action: 'ุชู ุงูุฅูุดุงุก', by: 'ูุฏูุฑ ุงููุธุงู', date: '2025-06-12'}] },
        { id: 3, type: 'incoming', number: '135/ุฌ', date: '2025-06-15', entity: 'ุฃูุงูุฉ ุจุบุฏุงุฏ', subject: 'ุงุณุชูุณุงุฑ ุญูู ุชุฑููู ููู ุชุงุฑูุฎู', status: 'in-progress', priority: 'normal', assigneeId: 1, notes: '', history: [{action: 'ุชู ุงูุฅูุดุงุก', by: 'ูุฏูุฑ ุงููุธุงู', date: '2025-06-15'}] },
        { id: 4, type: 'incoming', number: '140/ุฏ', date: '2025-06-20', entity: 'ููุงุทู', subject: 'ุดููู ุจุฎุตูุต ุงุณุชุบูุงู ุฃุฑุถ ููู', status: 'new', priority: 'urgent', assigneeId: null, notes: 'ุชุญุชุงุฌ ุฅูู ุชุญููู ุนุงุฌู', history: [{action: 'ุชู ุงูุฅูุดุงุก', by: 'ูุฏูุฑ ุงููุธุงู', date: '2025-06-20'}] },
        { id: 5, type: 'outgoing', number: '350/ุจ', date: '2025-06-21', entity: 'ูุฒุงุฑุฉ ุงูุนุฏู', subject: 'ูุชุงุจุนุฉ ุฏุนูู ูุถุงุฆูุฉ', status: 'completed', priority: 'normal', assigneeId: 3, notes: 'ุชู ุฅุฑุณุงู ุงููุณุชูุฏุงุช ุงููุทููุจุฉ.', history: [{action: 'ุชู ุงูุฅูุดุงุก', by: 'ูุฏูุฑ ุงููุธุงู', date: '2025-06-21'}]}
    ];

    // --- DOM ELEMENTS ---
    const navLinks = document.querySelectorAll('.nav-link');
    const views = document.querySelectorAll('.view');
    const headerTitle = document.getElementById('header-title');

    // --- NAVIGATION ---
    function showView(viewId) {
        views.forEach(view => view.classList.add('hidden'));
        const activeView = document.getElementById(viewId + '-view');
        if (activeView) activeView.classList.remove('hidden');
        
        if (viewId === 'dashboard') updateDashboard();
        if (viewId === 'reports') updateReports();
    }

    navLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const viewId = this.getAttribute('href').substring(1);
            navLinks.forEach(l => l.classList.remove('bg-sky-100', 'text-sky-700', 'font-bold'));
            this.classList.add('bg-sky-100', 'text-sky-700', 'font-bold');
            headerTitle.textContent = this.textContent;
            showView(viewId);
        });
    });
    
    // --- STATUS HELPERS ---
    const getStatusInfo = (status) => {
        switch(status) {
            case 'new': return { text: 'ุฌุฏูุฏ', color: 'bg-amber-100 text-amber-800' };
            case 'in-progress': return { text: 'ููุฏ ุงูุฅุฌุฑุงุก', color: 'bg-indigo-100 text-indigo-800' };
            case 'completed': return { text: 'ููุฌุฒ', color: 'bg-green-100 text-green-800' };
            default: return { text: 'ุบูุฑ ูุนุฑูู', color: 'bg-gray-100 text-gray-800' };
        }
    };
    
    // --- CONFIRMATION MODAL ---
    const confirmModal = document.getElementById('confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    let deleteFunction = null;

    function showConfirmModal(onConfirm) {
        deleteFunction = onConfirm;
        confirmModal.classList.remove('hidden');
    }

    function hideConfirmModal() {
        confirmModal.classList.add('hidden');
        deleteFunction = null;
    }

    confirmDeleteBtn.addEventListener('click', () => {
        if (typeof deleteFunction === 'function') {
            deleteFunction();
        }
        hideConfirmModal();
    });
    confirmCancelBtn.addEventListener('click', hideConfirmModal);


    // --- MAIL MANAGEMENT ---
    const mailTableBody = document.getElementById('mailTableBody');
    const mailModal = document.getElementById('mail-modal');
    const mailForm = document.getElementById('mail-form');
    
    function populateMailTable(filter = '') {
        mailTableBody.innerHTML = '';
        const filteredData = mailData.filter(mail => mail.subject.includes(filter) || mail.entity.includes(filter));
        
        filteredData.forEach(mail => {
            const statusInfo = getStatusInfo(mail.status);
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="p-3 font-mono">${mail.number}</td>
                <td class="p-3">${mail.date}</td>
                <td class="p-3">${mail.type === 'incoming' ? 'ูุงุฑุฏ' : 'ุตุงุฏุฑ'}</td>
                <td class="p-3">${mail.entity}</td>
                <td class="p-3">${mail.subject.substring(0, 40)}...</td>
                <td class="p-3"><span class="status-badge ${statusInfo.color}">${statusInfo.text}</span></td>
                <td class="p-3">
                    <button class="view-details-btn text-sky-600 hover:underline" data-id="${mail.id}">ุชูุงุตูู</button>
                    <button class="edit-mail-btn text-green-600 hover:underline ms-2" data-id="${mail.id}">ุชุนุฏูู</button>
                </td>
            `;
            mailTableBody.appendChild(row);
        });
    }
    
    function showMailDetails(id) {
        const mail = mailData.find(m => m.id === id);
        if (!mail) return;
        
        const contentDiv = document.getElementById('mail-details-content');
        const statusInfo = getStatusInfo(mail.status);
        const assignee = employeeData.find(e => e.id === mail.assigneeId);
        
        const historyHTML = mail.history.map(h => `<p class="text-sm text-gray-500">${h.date}: ${h.action} (ุจูุงุณุทุฉ ${h.by})</p>`).join('');

        contentDiv.innerHTML = `
            <div class="border-b pb-4 mb-4">
                <div class="flex justify-between items-start">
                    <h2 class="text-3xl font-bold text-slate-800">${mail.subject}</h2>
                    <span class="status-badge ${statusInfo.color}">${statusInfo.text}</span>
                </div>
                <p class="text-md text-slate-600">ูู/ุฅูู: ${mail.entity}</p>
                <p class="text-sm text-gray-500">ุฑูู ุงููุชุงุจ: ${mail.number} | ุชุงุฑูุฎ: ${mail.date} | ุฃููููุฉ: ${mail.priority === 'urgent' ? 'ุนุงุฌู' : 'ุนุงุฏู'}</p>
            </div>
            <div>
                <h3 class="font-bold text-xl mb-2 text-sky-700">ุงูููุธู ุงููุณุคูู</h3>
                <p class="mb-4">${assignee ? assignee.name : 'ุบูุฑ ูุนูู'}</p>
                
                <h3 class="font-bold text-xl mb-2 text-sky-700">ููุงุญุธุงุช</h3>
                <p class="mb-4 bg-gray-50 p-3 rounded-lg">${mail.notes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช.'}</p>
                
                <h3 class="font-bold text-xl mb-2 text-sky-700">ุณุฌู ุงูุฅุฌุฑุงุกุงุช</h3>
                <div class="space-y-1">${historyHTML}</div>
            </div>
        `;
        showView('mail-details');
    }
    
    function openMailModal(id = null) {
        mailForm.reset();
        const assigneeSelect = document.getElementById('mail-assignee');
        assigneeSelect.innerHTML = '<option value="">ุบูุฑ ูุนูู</option>';
        employeeData.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = emp.name;
            assigneeSelect.appendChild(option);
        });

        if (id) {
            document.getElementById('mail-modal-title').textContent = 'ุชุนุฏูู ุจูุงูุงุช ุงูุจุฑูุฏ';
            const mail = mailData.find(m => m.id === id);
            if (!mail) return;
            document.getElementById('mail-id').value = mail.id;
            document.getElementById('mail-type').value = mail.type;
            document.getElementById('mail-number').value = mail.number;
            document.getElementById('mail-date').value = mail.date;
            document.getElementById('mail-entity').value = mail.entity;
            document.getElementById('mail-subject').value = mail.subject;
            document.getElementById('mail-priority').value = mail.priority;
            document.getElementById('mail-assignee').value = mail.assigneeId || '';
            document.getElementById('mail-notes').value = mail.notes;
        } else {
            document.getElementById('mail-modal-title').textContent = 'ุฅุถุงูุฉ ุจุฑูุฏ ุฌุฏูุฏ';
            document.getElementById('mail-id').value = '';
            document.getElementById('mail-date').value = new Date().toISOString().split('T')[0];
        }
        mailModal.classList.remove('hidden');
    }
    
    mailForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = Number(document.getElementById('mail-id').value);
        const mailItem = {
            type: document.getElementById('mail-type').value,
            number: document.getElementById('mail-number').value,
            date: document.getElementById('mail-date').value,
            entity: document.getElementById('mail-entity').value,
            subject: document.getElementById('mail-subject').value,
            priority: document.getElementById('mail-priority').value,
            assigneeId: Number(document.getElementById('mail-assignee').value) || null,
            notes: document.getElementById('mail-notes').value,
        };

        if (id) {
            const index = mailData.findIndex(m => m.id === id);
            if (index > -1) mailData[index] = { ...mailData[index], ...mailItem };
        } else {
            mailItem.id = Date.now();
            mailItem.status = 'new';
            mailItem.history = [{action: 'ุชู ุงูุฅูุดุงุก', by: 'ูุฏูุฑ ุงููุธุงู', date: new Date().toISOString().split('T')[0]}];
            mailData.unshift(mailItem);
        }
        populateMailTable();
        updateDashboard();
        mailModal.classList.add('hidden');
    });

    document.getElementById('mailSearch').addEventListener('keyup', (e) => populateMailTable(e.target.value));
    document.getElementById('add-mail-btn').addEventListener('click', () => openMailModal());
    mailTableBody.addEventListener('click', (e) => {
        if (e.target.closest('.view-details-btn')) showMailDetails(Number(e.target.closest('.view-details-btn').dataset.id));
        if (e.target.closest('.edit-mail-btn')) openMailModal(Number(e.target.closest('.edit-mail-btn').dataset.id));
    });
    document.querySelector('.back-to-mail').addEventListener('click', () => showView('mail'));


    // --- HR MANAGEMENT ---
    const employeeTableBody = document.getElementById('employeeTableBody');
    const employeeModal = document.getElementById('employee-modal');
    const employeeForm = document.getElementById('employee-form');
    
    function populateEmployeeTable() {
        employeeTableBody.innerHTML = '';
        employeeData.forEach(emp => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="p-3">${emp.name}</td>
                <td class="p-3">${emp.title}</td>
                <td class="p-3">${emp.department}</td>
                <td class="p-3">
                    <button class="edit-employee-btn text-green-600 hover:underline" data-id="${emp.id}">ุชุนุฏูู</button>
                    <button class="delete-employee-btn text-red-600 hover:underline ms-2" data-id="${emp.id}">ุญุฐู</button>
                </td>
            `;
            employeeTableBody.appendChild(row);
        });
    }

    function openEmployeeModal(id = null) {
        employeeForm.reset();
        if (id) {
            document.getElementById('employee-modal-title').textContent = 'ุชุนุฏูู ุจูุงูุงุช ุงูููุธู';
            const emp = employeeData.find(e => e.id === id);
            if (!emp) return;
            document.getElementById('employee-id').value = emp.id;
            document.getElementById('employee-name').value = emp.name;
            document.getElementById('employee-title').value = emp.title;
            document.getElementById('employee-department').value = emp.department;
        } else {
            document.getElementById('employee-modal-title').textContent = 'ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ';
            document.getElementById('employee-id').value = '';
        }
        employeeModal.classList.remove('hidden');
    }

    function deleteEmployee(id) {
        showConfirmModal(() => {
            employeeData = employeeData.filter(emp => emp.id !== id);
            populateEmployeeTable();
        });
    }

    employeeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = Number(document.getElementById('employee-id').value);
        const empItem = {
            name: document.getElementById('employee-name').value,
            title: document.getElementById('employee-title').value,
            department: document.getElementById('employee-department').value,
        };

        if (id) {
            const index = employeeData.findIndex(e => e.id === id);
            if (index > -1) employeeData[index] = { ...employeeData[index], ...empItem };
        } else {
            empItem.id = Date.now();
            employeeData.push(empItem);
        }
        populateEmployeeTable();
        employeeModal.classList.add('hidden');
    });

    document.getElementById('add-employee-btn').addEventListener('click', () => openEmployeeModal());
    employeeTableBody.addEventListener('click', (e) => {
        if (e.target.closest('.edit-employee-btn')) openEmployeeModal(Number(e.target.closest('.edit-employee-btn').dataset.id));
        if (e.target.closest('.delete-employee-btn')) deleteEmployee(Number(e.target.closest('.delete-employee-btn').dataset.id));
    });


    // --- UNIVERSAL MODAL CANCEL ---
    document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.modal-overlay').classList.add('hidden');
        });
    });

    // --- CHART INSTANCES ---
    let mailStatusChartInstance, mailVolumeChartInstance, priorityReportChartInstance, typeReportChartInstance, employeePerformanceChartInstance;

    // --- DASHBOARD ---
    function updateDashboard() {
        const total = mailData.length;
        const newCount = mailData.filter(m => m.status === 'new').length;
        const progressCount = mailData.filter(m => m.status === 'in-progress').length;
        const completedCount = mailData.filter(m => m.status === 'completed').length;
        
        document.getElementById('total-mail-kpi').textContent = total;
        document.getElementById('new-mail-kpi').textContent = newCount;
        document.getElementById('progress-mail-kpi').textContent = progressCount;
        document.getElementById('completed-mail-kpi').textContent = completedCount;

        if (mailStatusChartInstance) mailStatusChartInstance.destroy();
        mailStatusChartInstance = new Chart(document.getElementById('mailStatusChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['ุฌุฏูุฏ', 'ููุฏ ุงูุฅุฌุฑุงุก', 'ููุฌุฒ'],
                datasets: [{ data: [newCount, progressCount, completedCount], backgroundColor: ['#f59e0b', '#4f46e5', '#22c55e'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        if (mailVolumeChartInstance) mailVolumeChartInstance.destroy();
        mailVolumeChartInstance = new Chart(document.getElementById('mailVolumeChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: ['ููุงูุฑ', 'ูุจุฑุงูุฑ', 'ูุงุฑุณ', 'ุฃุจุฑูู', 'ูุงูู', 'ููููู'],
                datasets: [{ label: 'ุนุฏุฏ ุงููุนุงููุงุช', data: [12, 19, 15, 25, 22, 30], backgroundColor: '#0ea5e955', borderColor: '#0ea5e9', tension: 0.3, fill: true }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- REPORTS ---
    function updateReports() {
        // Priority Chart
        const urgentCount = mailData.filter(m => m.priority === 'urgent').length;
        const normalCount = mailData.filter(m => m.priority === 'normal').length;
        if (priorityReportChartInstance) priorityReportChartInstance.destroy();
        priorityReportChartInstance = new Chart(document.getElementById('priority-report-chart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['ุนุงุฌู', 'ุนุงุฏู'],
                datasets: [{ data: [urgentCount, normalCount], backgroundColor: ['#ef4444', '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        
        // Type Chart
        const incomingCount = mailData.filter(m => m.type === 'incoming').length;
        const outgoingCount = mailData.filter(m => m.type === 'outgoing').length;
        if (typeReportChartInstance) typeReportChartInstance.destroy();
        typeReportChartInstance = new Chart(document.getElementById('type-report-chart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['ูุงุฑุฏ', 'ุตุงุฏุฑ'],
                datasets: [{ data: [incomingCount, outgoingCount], backgroundColor: ['#8b5cf6', '#14b8a6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Employee Performance Chart
        const employeeTasks = {};
        employeeData.forEach(emp => {
            employeeTasks[emp.id] = { name: emp.name, completed: 0, inProgress: 0, new: 0 };
        });
        mailData.forEach(mail => {
            if (mail.assigneeId && employeeTasks[mail.assigneeId]) {
                if (mail.status === 'completed') employeeTasks[mail.assigneeId].completed++;
                else if (mail.status === 'in-progress') employeeTasks[mail.assigneeId].inProgress++;
                else if (mail.status === 'new') employeeTasks[mail.assigneeId].new++;
            }
        });

        const labels = Object.values(employeeTasks).map(e => e.name);
        const completedData = Object.values(employeeTasks).map(e => e.completed);
        const inProgressData = Object.values(employeeTasks).map(e => e.inProgress);
        const newData = Object.values(employeeTasks).map(e => e.new);
        
        if (employeePerformanceChartInstance) employeePerformanceChartInstance.destroy();
        employeePerformanceChartInstance = new Chart(document.getElementById('employee-performance-chart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ููุฌุฒ', data: completedData, backgroundColor: '#22c55e' },
                    { label: 'ููุฏ ุงูุฅุฌุฑุงุก', data: inProgressData, backgroundColor: '#4f46e5' },
                    { label: 'ุฌุฏูุฏ', data: newData, backgroundColor: '#f59e0b' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
        });
    }


    // --- INITIAL LOAD ---
    populateMailTable();
    populateEmployeeTable();
    updateDashboard();
    showView('dashboard');
});
</script>

</body>
</html>
